<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Homepage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="d-flex justify-content-end gap-2 mb-3">
            <span id="firstName" class="align-self-center fw-bold text-primary"></span>
            <img id="avatar" width="40" height="40" style="border-radius: 50%; object-fit: cover;"/>
            <button id="logout" class="btn btn-danger" onclick="logout()">Logout</button>
            <a href="/PaymentSystemForCafe/frontend/order.html" class="btn btn-danger">Order</a>
        </div>
        <div class="col-md-12 offset-md-1">
            <div id="category-list" class="d-flex flex-wrap gap-2 mb-4"></div>
        </div>
        <div class="col-md-8">
            <div class="row" id="product-list"></div>
        </div>

        <div class="col-md-3">
            <h5>Basket</h5>
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Count</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody id="basket-list"></tbody>
            </table>
            <div class="text-end mb-2">
                <strong>Total: <span id="basket-total">0</span> so'm</strong>
            </div>
            <div class="text-end">
                <button class="btn btn-danger" onclick="confirm()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

    function getCategories() {
        axios({
            url: "http://localhost:8080/api/category",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            let s = `<button class="btn btn-outline-primary" onclick="getProducts(null)">All</button>`;
            for (let item of res.data) {
                s += `<button class="btn btn-outline-primary" onclick="getProducts(${item.id})">${item.name}</button>`;
            }
            document.getElementById("category-list").innerHTML = s;
        }).catch(err => {
            console.error("Error loading categories:", err);
        });
    }

    function getProducts(categoryId = null) {
        const url = categoryId === null
            ? "http://localhost:8080/api/product/isActive"
            : "http://localhost:8080/api/product/category/" + categoryId;

        axios({
            url: url,
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            console.log(res.data);
            let s = "";
            let basket = JSON.parse(localStorage.getItem("basket")) || [];

            for (let item of res.data) {
                let inBasket = basket.some(p => p.id === item.id);
                let buttonText = inBasket ? "Remove" : "Add Basket";
                let buttonClass = inBasket ? "btn-danger" : "btn-success";

                s += `
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                        <div class="card h-100">
                            <div class="text-center" style="height: 200px; overflow: hidden;">
                                <img src="http://localhost:8080/api/file/${item.attachmentId}" class="img-fluid h-100" style="object-fit: contain;" alt="Image Not Found">
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-text">${item.name}</h5>
                                <h5 class="card-text">${item.price} so'm</h5>
                                <div class="d-flex justify-content-center align-items-center gap-2 my-2">
                                    <button class="btn ${buttonClass} mt-auto" onclick="addToBasket(${item.id}, event)">
                                        ${buttonText}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById("product-list").innerHTML = s;
        }).catch(err => {
            console.error("Error loading products:", err);
        });
    }

    function addToBasket(productId, event) {
        let basket = JSON.parse(localStorage.getItem("basket")) || [];
        const button = event.target;
        const index = basket.findIndex(p => p.id === productId);

        if (index !== -1) {
            basket.splice(index, 1);
            button.innerText = "Add Basket";
            button.classList.remove("btn-danger");
            button.classList.add("btn-success");
        } else {
            basket.push({id: productId, count: 1});
            button.innerText = "Remove";
            button.classList.remove("btn-success");
            button.classList.add("btn-danger");
        }

        localStorage.setItem("basket", JSON.stringify(basket));
        showBasket();
    }

    function showBasket() {
        let total = 0;
        axios({
            url: "http://localhost:8080/api/product/isActive",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            const allProducts = res.data;
            const basket = JSON.parse(localStorage.getItem("basket")) || [];

            let s = "";

            for (let b of basket) {
                const item = allProducts.find(p => p.id === b.id);
                if (!item) continue;

                s += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.price}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-danger btn-sm" onclick="changeCount(${item.id}, 'minus')">−</button>
                                <button class="btn btn-light btn-sm" disabled>${b.count}</button>
                                <button class="btn btn-outline-success btn-sm" onclick="changeCount(${item.id}, 'plus')">+</button>
                            </div>
                        </td>
                        <td>${(item.price * b.count).toFixed(2)}</td>
                    </tr>
                `;
                total += item.price * b.count;
            }

            document.getElementById("basket-list").innerHTML = s;
            document.getElementById("basket-total").innerText = total.toFixed(2);
        }).catch(error => {
            console.error("Xatolik:", error.response?.status, error.message);
        });
    }

    function changeCount(productId, action) {
        let basket = JSON.parse(localStorage.getItem("basket")) || [];
        const index = basket.findIndex(p => p.id === productId);
        if (index !== -1) {
            if (action === "plus") {
                basket[index].count += 1;
            } else if (action === "minus") {
                if (basket[index].count > 1) {
                    basket[index].count -= 1;
                }
            }
        }

        localStorage.setItem("basket", JSON.stringify(basket));
        showBasket();
    }

    function confirm() {
        let basket = JSON.parse(localStorage.getItem("basket")) || [];
        if (basket.length === 0) {
            alert("Savatcha bo‘sh. Iltimos, mahsulot tanlang.");
            return;
        }
        axios({
            url: "http://localhost:8080/api/order",
            method: "POST",
            data: basket,
            headers: {
                "Authorization": localStorage.getItem("token"),
                "Content-Type": "application/json"
            }
        }).then(res => {
            console.log("Order created successfully:", res.data);
            localStorage.removeItem("basket");
            showBasket();
            getProducts();
        }).catch(err => {
            console.error("Error creating order:", err);
        });
    }

    function getMe() {
        const token = localStorage.getItem("token");

        if (!token) {
            console.warn("Token topilmadi.");
            return;
        }

        axios({
            url: "http://localhost:8080/api/user/me",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }

        }).then(res => {
            document.getElementById("firstName").innerHTML = res.data.firstName;
            document.getElementById("avatar").src = "http://localhost:8080/api/file/" + res.data.attachmentId;
        }).catch(err => {
            console.error("Error:", err);
        });
    }

    function logout() {
        axios({
            url: "http://localhost:8080/api/logout",
            method: "POST",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            console.log("Logout javobi:", res.data);

            // ✅ Tokenni localStorage'dan o‘chirish
            localStorage.removeItem("token");

            // ✅ Login sahifasiga yo‘naltirish
            window.location.href = "http://localhost:63342/PaymentSystemForCafe/frontend/login.html?_ijt=pv38qdp5a693qd6ignjjcnntf6&_ij_reload=RELOAD_ON_SAVE";


        }).catch(err => {
            console.error("Logout xatolik:", err);

            // ❗ Xatolik bo‘lsa ham, foydalanuvchini tokenni o‘chirib yuborish xavfsiz
            localStorage.removeItem("token");
            window.location.href = "/login.html";
        });
    }

    getCategories();
    getProducts();
    showBasket();
    getMe();

</script>

</body>
</html>
