<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Categories Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="d-flex justify-content-end gap-2 mb-3">
            <!--            <img id="avatar" width="40" height="40" style="border-radius: 50%; object-fit: cover;"/>-->
            <span id="firstName" class="align-self-center fw-bold text-primary"></span>
            <button id="logout" class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
        <!-- Sidebar -->
        <div class="col-md-3">
            <button class="btn btn-primary mb-2 w-100" onclick="getCategories()">Categories</button>
            <button class="btn btn-primary mb-2 w-100" onclick="getProducts()">Products</button>
            <a href="/PaymentSystemForCafe/frontend/report.html" class="btn btn-primary mb-2 w-100">Order</a>
        </div>
        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Category Table Wrapper (Initially hidden) -->
            <div id="category-table" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Category List</h4>
                    <button class="btn btn-success" onclick="openCategory()">+ Add Category</button>
                </div>
                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Delete</th>
                        <th>Update</th>
                    </tr>
                    </thead>
                    <tbody id="tbody">
                    </tbody>
                </table>
            </div>
            <div id="product-table" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Product List</h4>
                    <button class="btn btn-success" onclick="openProduct()">+ Add Product</button>
                </div>

                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Picture</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>IsActive</th>
                        <th>Category Name</th>
                        <th>Delete</th>
                        <th>Update</th>
                    </tr>
                    </thead>
                    <tbody id="tbody1">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form onsubmit="addCategory(event)">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
                </div>
                <div class="modal-body">
                    <input id="category-name" type="text" class="form-control" placeholder="Category Name" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="text-center">
                <label class="mb-2">
                    <img id="img" src="images/default.jpg" width="100" height="100">
                    <!--                    <img id="img" src="src/main/resources/static/images/default.jpg-->
                    <!--" width="100" height="100">-->
                    <input style="display: none;cursor: pointer" onchange="uploadFile(event)" type="file">
                </label>
            </div>
            <form onsubmit="addProduct(event)">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Add Product</h5>
                </div>
                <div class="modal-body">
                    <input id="product-name" type="text" class="form-control" placeholder="Product Name" required>
                </div>
                <div class="modal-body">
                    <input id="product-price" type="text" class="form-control" placeholder="Product Price" required>
                </div>
                <div class="modal-body">
                    <select id="selectCategory" name="categoryId" class="form-select"></select>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="isActive" name="isActive">
                    <label class="form-check-label" for="isActive">
                        isActive
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let attachmentId = "";
    let currentCategoryId = "";
    let currentProductId = "";

    function openCategory(categoryId) {
        currentCategoryId = categoryId;
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        if (currentCategoryId) {
            document.getElementById("categoryModalLabel").innerText = "Update category"
            axios({
                url: "http://localhost:8080/api/category/" + currentCategoryId,
                method: "GET",
                headers: {
                    "Authorization": localStorage.getItem("token")
                }

            }).then(res => {
                document.getElementById("category-name").value = res.data.name
                modal.show();
            }).catch(err => {
                console.error("Error:", err);
            });

        } else {
            document.getElementById("categoryModalLabel").innerText = "Add category"
            document.getElementById("category-name").value = "";
            modal.show();
        }
    }

    function getCategories() {
        document.getElementById("product-table").classList.add("d-none");
        document.getElementById("category-table").classList.remove("d-none");
        axios({
            url: "http://localhost:8080/api/category",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            document.getElementById("category-table").classList.remove("d-none");

            let tbody = document.getElementById("tbody");
            let s = "";
            for (let item of res.data) {
                s += `<tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteCategory(${item.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                     <td>
                     <button class="btn btn-warning btn-sm" onclick="openCategory(${item.id})">
                          <i class="bi bi-pencil"></i> Update
                     </button>

                     </td>

                </tr>`;
            }
            tbody.innerHTML = s;
        }).catch(err => {
            console.error("Error:", err);
        });
    }

    function addCategory(event) {
        event.preventDefault();
        const name = document.getElementById("category-name").value;
        axios({
            url: currentCategoryId ? "http://localhost:8080/api/category/" + currentCategoryId : "http://localhost:8080/api/category",
            method: currentCategoryId ? "PUT" : "POST",
            data: {
                name: name
            },
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            const modalElement = document.getElementById('categoryModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            getCategories();
            document.getElementById("category-name").value = "";
        }).catch(err => {
            console.error("Error:", err);
        });
    }

    function deleteCategory(id) {
        axios({
            url: "http://localhost:8080/api/category/" + id,
            method: "DELETE",
            headers: {
                "Authorization": localStorage.getItem("token")
            }

        }).then(res => {
            getCategories();
        }).catch(err => {
            if (err.response && err.response.data && err.response.data.message) {
                alert("❌ " + err.response.data.message);
            } else {
                alert("❌ Noma'lum xatolik yuz berdi.");
            }
        });
    }

    function getProducts() {
        document.getElementById("category-table").classList.add("d-none");
        document.getElementById("product-table").classList.remove("d-none");
        axios({
            url: "http://localhost:8080/api/product",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }

        }).then(res => {
            document.getElementById("product-table").classList.remove("d-none");
            let tbody1 = document.getElementById("tbody1");
            let s = "";
            for (let item of res.data) {
                s += `<tr>
                    <td>${item.id}</td>
                    <td>
                        ${item.attachmentId ? `<img src="http://localhost:8080/api/file/${item.attachmentId}" alt="topilmadi" height="50" width="50">` : 'Rasm yo‘q'}
                    </td>

                    <td>${item.name}</td>
                    <td>${item.price}</td>
                    <td>${item.isActive}</td>
                    <td>${item.categoryName}</td>

                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${item.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openProduct(${item.id})">
                            <i class="bi bi-pencil"></i> Update
                        </button>
                    </td>
                </tr>`;
            }
            tbody1.innerHTML = s;
        }).catch(err => {
            console.error("Error:", err);
        });
    }

    function openProduct(productId) {
        currentProductId = productId;
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        selectCategoryForAddProduct()

        if (currentProductId) {
            document.getElementById("productModalLabel").innerText = "Update product";
            axios({
                url: "http://localhost:8080/api/product/" + currentProductId,
                method: "GET",
                headers: {
                    "Authorization": localStorage.getItem("token")
                }
            }).then(res => {
                document.getElementById("product-name").value = res.data.name;
                document.getElementById("product-price").value = res.data.price;
                document.getElementById("selectCategory").value = res.data.categoryName;
                document.getElementById("isActive").checked = res.data.isActive;
                attachmentId = res.data.attachmentId;
                document.getElementById("img").src = "http://localhost:8080/api/file/" + res.data.attachmentId;
                modal.show();

            }).catch(err => {
                console.error("Error:", err);
            });
        } else {
            document.getElementById("productModalLabel").innerText = "Add product";
            document.getElementById("img").src = "images/default.jpg";
            attachmentId = null;
            document.getElementById("product-name").value = "";
            document.getElementById("product-price").value = "";
            document.getElementById("selectCategory").selectedIndex = 0;
            document.getElementById("isActive").checked = false;
            modal.show();
        }
    }

    function uploadFile(event) {
        let file = event.target.files[0];
        let formData = new FormData();
        formData.append("file", file)
        axios.post('http://localhost:8080/api/file', formData, {
            headers: {
                "Content-Type": "multipart/form-data",
                "Authorization": localStorage.getItem("token")
            },
        }).then(res => {
            document.getElementById("img").src = "http://localhost:8080/api/file/" + res.data
            attachmentId = res.data;
        })
    }

    function addProduct(event) {

        event.preventDefault();
        const name = document.getElementById("product-name").value;
        const price = parseInt(document.getElementById("product-price").value);
        const categoryId = document.getElementById("selectCategory").value;
        const isActive = document.getElementById("isActive").checked;

        axios({
            url: currentProductId ? "http://localhost:8080/api/product/" + currentProductId : "http://localhost:8080/api/product",
            method: currentProductId ? "PUT" : "POST",
            data: {
                name: name,
                price: price,
                categoryId: categoryId,
                isActive: isActive,
                attachmentId: attachmentId
            },
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            const modalElement = document.getElementById('productModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            getProducts();
            document.getElementById("product-name").value = "";
            document.getElementById("product-price").value = "";
            document.getElementById("selectCategory").value = "";
            document.getElementById("isActive").checked = false;

        }).catch(err => {
            console.error("Error:", err);

        });

    }

    function selectCategoryForAddProduct() {
        axios({
            url: "http://localhost:8080/api/category",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            let s = `<option selected disabled>Select Category</option>`;
            for (let item of res.data) {
                s += `<option value="${item.id}">${item.name}</option>`
            }
            document.getElementById("selectCategory").innerHTML = s;
        }).catch(err => {
            console.error("Error:", err);

        });
    }

    function deleteProduct(id) {
        axios({
            url: "http://localhost:8080/api/product/" + id,
            method: "DELETE",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            getProducts();
        }).catch(err => {
            console.error("Error:", err);

        });
    }

    function getMe() {
        const token = localStorage.getItem("token");

        if (!token) {
            console.warn("Token topilmadi.");
            return;
        }

        axios({
            url: "http://localhost:8080/api/user/me",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            document.getElementById("firstName").innerHTML = res.data.firstName;
        }).catch(err => {
            console.error("Error:", err);
        });
    }

    getMe();

    function logout() {
        axios({
            url: "http://localhost:8080/api/logout",
            method: "POST",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            console.log("Logout javobi:", res.data);

            // ✅ Tokenni localStorage'dan o‘chirish
            localStorage.removeItem("token");

            // ✅ Login sahifasiga yo‘naltirish
            window.location.href = "/login.html";

        }).catch(err => {
            console.error("Logout xatolik:", err);

            // ❗ Xatolik bo‘lsa ham, foydalanuvchini tokenni o‘chirib yuborish xavfsiz
            localStorage.removeItem("token");
            window.location.href = "/login.html";
        });
    }


</script>

</body>
</html>

