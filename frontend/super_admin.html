<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-4">Super Admin Panel</h2>
    <div class="d-flex justify-content-end gap-2 mb-3">
        <span id="firstName" class="align-self-center fw-bold text-primary"></span>
        <img id="avatar" width="40" height="40" style="border-radius: 50%; object-fit: cover;"/>
        <button id="logout" class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <div id="user-table" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-success" onclick="openUser()">+ Add User</button>
        </div>
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>Image</th>
                <th>Full Name</th>
                <th>Roles</th>
                <th>Delete</th>
                <th>Update</th>
            </tr>
            </thead>
            <tbody id="tbody">
            <!-- rows will be added here -->
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="text-center">
                <label class="mb-2">
                    <img id="img" src="images/default.jpg" width="100" height="100">
                    <!--                    <img id="img" src="src/main/resources/static/images/default.jpg-->
                    <!--" width="100" height="100">-->
                    <input style="display: none;cursor: pointer" onchange="userUploadFile(event)" type="file">
                </label>
            </div>
            <form onsubmit="addUser(event)">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Add User</h5>
                </div>
                <div class="modal-body">
                    <input id="user-firstName" type="text" class="form-control" placeholder="FirstName" required>
                </div>
                <div class="modal-body">
                    <input id="user-lastName" type="text" class="form-control" placeholder="LastName" required>
                </div>
                <div class="modal-body">
                    <input id="user-userName" type="text" class="form-control" placeholder="UserName" required>
                </div>
                <div class="modal-body">
                    <input id="user-password" type="password" class="form-control" placeholder="Password" required>
                </div>
                <!--                <div class="modal-body">-->
                <!--                    <select id="selectRole" name="roleId" class="form-select"></select>-->
                <!--                </div>-->
                <div class="modal-body">
                    <select id="selectRole" name="roleId" class="form-select" onchange="addRoleToList(this)">
                        <option selected disabled>Select Role</option>
                    </select>
                </div>

                <!-- Tanlangan role’lar chiqadigan joy -->
                <div class="modal-body">
                    <div id="selectedRoles" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let selectedRoleIds = [];
    let attachmentId = "";
    let currentUserId = "";

    function getAllUsers() {
        axios({
            url: "http://localhost:8080/api/super_admin",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            let tbody = document.getElementById("tbody");
            let userTable = document.getElementById("user-table");

            let html = "";
            for (let item of res.data) {
                html += `
                <tr>
                    <td>
                        ${item.attachmentId ? `<img src="http://localhost:8080/api/file/${item.attachmentId}" alt="topilmadi" height="50" width="50">` : 'Rasm yo‘q'}
                    </td>
                    <td>${item.fullName}</td>
                    <td>${item.roleName}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${item.id})">Delete</button></td>
                    <td><button class="btn btn-warning btn-sm" onclick="openUser(${item.id})">Update</button></td>
                </tr>
            `;
            }
            tbody.innerHTML = html;
            userTable.classList.remove("d-none");
        }).catch(err => {
            console.error("Error loading users:", err);
        });
    }

    getAllUsers();

    function openUser(userId) {
        let modal = new bootstrap.Modal(document.getElementById('userModal'));
        currentUserId = userId;
        selectRoleForAddUser();
        if (currentUserId) {
            document.getElementById("userModalLabel").innerText = "Update User";
            axios({
                url: "http://localhost:8080/api/super_admin/" + currentUserId,
                method: "GET",
                headers: {
                    "Authorization": localStorage.getItem("token"),
                }
            }).then(res => {
                console.log(res.data);
                document.getElementById("user-firstName").value = res.data.firstName;
                document.getElementById("user-lastName").value = res.data.lastName;
                document.getElementById("user-userName").value = res.data.username;
                document.getElementById("user-password").value = res.data.password;
                attachmentId = res.data.attachmentId;
                document.getElementById("img").src = "http://localhost:8080/api/file/" + res.data.attachmentId;

                // selectedRoleIds = [];
                // document.getElementById("selectedRoles").innerHTML = "";

                for (let role of res.data.roleResDtos) {
                    selectedRoleIds.push(role.id);

                    let container = document.getElementById("selectedRoles");

                    let badge = document.createElement("span");
                    badge.className = "badge bg-primary d-flex align-items-center gap-2 p-2";
                    badge.innerHTML = `
                     ${role.roleName}
                   <button type="button" class="btn-close btn-close-white" aria-label="Remove"></button>
                  `;

                    badge.querySelector("button").onclick = function () {
                        container.removeChild(badge);
                        selectedRoleIds = selectedRoleIds.filter(id => id !== role.id); // ✅ string emas, number
                        console.log("Tanlangan rollar:", selectedRoleIds);

                    };

                    container.appendChild(badge);
                }
                modal.show();

            }).catch(err => {
                console.error("Error loading users:", err);
            });

        } else {

            document.getElementById("userModalLabel").innerText = "Add User"
            document.getElementById("user-firstName").value = "";
            document.getElementById("user-lastName").value = "";
            document.getElementById("user-userName").value = "";
            document.getElementById("user-password").value = ""
            document.getElementById("selectRole").selectedIndex = "";
            document.getElementById("img").src = "images/default.jpg";
            modal.show();

        }


    }

    function addUser(event) {
        event.preventDefault();

        const firstName = document.getElementById("user-firstName").value;
        const lastName = document.getElementById("user-lastName").value;
        const username = document.getElementById("user-userName").value;
        const password = document.getElementById("user-password").value;

        axios({
            url: currentUserId ? "http://localhost:8080/api/super_admin/" + currentUserId : "http://localhost:8080/api/super_admin",
            method: currentUserId ? "PUT" : "POST",
            data: {
                firstName: firstName,
                lastName: lastName,
                username: username,
                password: password,
                roleIds: selectedRoleIds,   // Bir nechta role yuborilyapti
                attachmentId: attachmentId
            },
            headers: {
                "Authorization": localStorage.getItem("token"),
            }
        }).then(res => {
            console.log(res.data);
            let modalElement = document.getElementById("userModal");
            let modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            getAllUsers();
            document.querySelector("#userModal form").reset();
            document.getElementById("img").src = "images/default.jpg";
            attachmentId = "";
            selectedRoleIds = [];
            document.getElementById("selectedRoles").innerHTML = "";
        }).catch(err => {
            console.error("Error loading users:", err);
        });
    }

    function selectRoleForAddUser() {

        axios({
            url: "http://localhost:8080/api/super_admin/role",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            let s = `<option selected disabled>Select Role</option>`;
            for (let item of res.data) {
                // console.log(res.data)
                s += `<option value="${item.id}">${item.roleName}</option>`
            }
            document.getElementById("selectRole").innerHTML = s;
        }).catch(err => {
            console.error("Error:", err);

        });
    }

    function userUploadFile(event) {
        let file = event.target.files[0];
        let formData = new FormData();
        formData.append("file", file)
        axios.post('http://localhost:8080/api/file', formData, {
            headers: {
                "Content-Type": "multipart/form-data",
                "Authorization": localStorage.getItem("token")
            },
        }).then(res => {
            document.getElementById("img").src = "http://localhost:8080/api/file/" + res.data
            attachmentId = res.data;
        })
    }

    function addRoleToList(select) {
        const roleId = parseInt(select.value);   // ✅ string emas, number
        const roleName = select.options[select.selectedIndex].text;

        // Agar oldin qo‘shilgan bo‘lsa - qayt
        if (selectedRoleIds.includes(roleId)) return;

        selectedRoleIds.push(roleId);

        let container = document.getElementById("selectedRoles");

        let badge = document.createElement("span");
        badge.className = "badge bg-primary d-flex align-items-center gap-2 p-2";
        badge.innerHTML = `
        ${roleName}
        <button type="button" class="btn-close btn-close-white" aria-label="Remove"></button>
    `;

        // ❌ bosilganda o‘chirish
        badge.querySelector("button").onclick = function () {
            container.removeChild(badge);
            selectedRoleIds = selectedRoleIds.filter(id => id !== roleId);  // ✅ endi ishlaydi
        };

        container.appendChild(badge);
    }



    function deleteUser(id) {
        axios({
            url: "http://localhost:8080/api/super_admin/" + id,
            method: "DELETE",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            // console.log(res.data);
            getAllUsers();
        }).catch(err => {
            console.error("Error:", err);

        });
    }

    function getMe() {
        const token = localStorage.getItem("token");

        if (!token) {
            console.warn("Token topilmadi.");
            return;
        }

        axios({
            url: "http://localhost:8080/api/user/me",
            method: "GET",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            document.getElementById("firstName").innerHTML = res.data.firstName;
            document.getElementById("avatar").src = "http://localhost:8080/api/file/" + res.data.attachmentId;

        }).catch(err => {
            console.error("Error:", err);
        });
    }

    getMe();

    function logout() {
        axios({
            url: "http://localhost:8080/api/logout",
            method: "POST",
            headers: {
                "Authorization": localStorage.getItem("token")
            }
        }).then(res => {
            console.log("Logout javobi:", res.data);

            // ✅ Tokenni localStorage'dan o‘chirish
            localStorage.removeItem("token");

            // ✅ Login sahifasiga yo‘naltirish
            window.location.href = "http://localhost:63342/PaymentSystemForCafe/frontend/login.html?_ijt=pv38qdp5a693qd6ignjjcnntf6&_ij_reload=RELOAD_ON_SAVE";

        }).catch(err => {
            console.error("Logout xatolik:", err);

            // ❗ Xatolik bo‘lsa ham, foydalanuvchini tokenni o‘chirib yuborish xavfsiz
            localStorage.removeItem("token");
            window.location.href = "/login.html";
        });
    }


</script>

</body>
</html>
